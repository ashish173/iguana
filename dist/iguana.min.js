angular.module("Iguana",["SuperModel","ngResource"]).provider("Iguana",function(){this._defaultBaseUrl="",this.setAdapter=function(a){this._defaultAdapterName=a},this.setBaseUrl=function(a){this._defaultBaseUrl=a},this.$get=["SuperModel","Iguana.Alias","Iguana.Callbacks","Iguana.Crud","Iguana.Embeds","Iguana.Serializers","Iguana.SingleCollectionInheritance",function(a){var b=Array.prototype.slice.call(arguments,1),c=a.subclass(function(){return angular.forEach(b,function(a){this.extend(a.classMixin||{}),this.include(a.instanceMixin||{}),a.included&&a.included(this)}.bind(this)),this.extend({expect:function(){throw new Error("There is no 'expect' method.  Make sure to include iguana-mock.js and inject MockIguana.")}}),{initialize:function(a){if(void 0===a&&(a={}),"object"!=typeof a||"[object Array]"===Object.prototype.toString.call(a))throw new Error("Expecting to instantiate Iguana class with object, got '"+a+"'");this.copyAttrsOnInitialize(a)},copyAttrsOnInitialize:function(a){this.$$sourceAttrs=a,this.runCallbacks("copyAttrsOnInitialize",function(){this.copyAttrs()})},copyAttrs:function(a){a&&(this.$$sourceAttrs=a),this.runCallbacks("copyAttrs",function(){angular.extend(this,this.$$sourceAttrs)})}}});return this._defaultAdapterName&&c.setAdapter(this._defaultAdapterName),c.setBaseUrl(this._defaultBaseUrl),c}]}),angular.module("Iguana").factory("Iguana.Adapters.AdapterBase",["$q","SuperModel",function(a,b){return b.subclass(function(){return{initialize:function(a){this.iguanaKlass=a},show:function(){throw new Error("Adapter does not support show method")},index:function(){throw new Error("Adapter does not support index method")},create:function(){throw new Error("Adapter does not support create method")},update:function(){throw new Error("Adapter does not support update method")},destroy:function(){throw new Error("Adapter does not support destroy method")}}})}]),angular.module("Iguana.Adapters.RestfulIdStyle",["Iguana","ngResource"]).factory("Iguana.Adapters.RestfulIdStyle",["Iguana.Adapters.AdapterBase","$resource","$q",function(a,b,c){return a.subclass(function(){return{name:"Iguana.Adapters.RestfulIdStyle",index:function(a,b){return this._makeApiCall(a,"index",b)},show:function(a,b,c){if(!b)throw new Error("No id provided");return c=c||{},c[this.idProperty]=b,this._makeApiCall(a,"show",c)},create:function(a,b){return this._makeApiCall(a,"create",{record:b})},update:function(a,b){return this._makeApiCall(a,"update",{record:b})},destroy:function(a,b){if(!b)throw new Error("No id provided");var c={};return c[this.idProperty]=b,this._makeApiCall(a,"destroy",c)},_makeApiCall:function(a,b,d){var e=c.defer(),f=this._getResource(a),a=this.iguanaKlass.collection;if(!a)throw new Error("No collection defined on iguana class.");return f[b](d,function(b){e.resolve({result:b.contents[a]||[],meta:b.meta})},function(a){e.reject(a)}),e.promise},_getResource:function(a){var c=[this.iguanaKlass.baseUrl,a,":"+this.idProperty].join("/")+".json";return b(c,{},{index:{method:"GET"},show:{method:"GET"},create:{method:"POST"},update:{method:"PUT"},destroy:{method:"DELETE"}})}}})}]),angular.module("Iguana").factory("Iguana.Alias",["$injector",function(a){return{classMixin:{injectablesMap:{},alias:function(a){if(a){if(this._alias=a,this._aliasedKlasses[a])throw new Error('A klass has already been aliased to "'+a+'".  Cannot alias another to the same name.');this._aliasedKlasses[a]=this}return this._alias},getAliasedKlass:function(b){if(!this._aliasedKlasses[b]){var c=this.injectablesMap[b];if(c){var d;try{d=a.get(c)}catch(e){}this._aliasedKlasses[b]=d}}if(!this._aliasedKlasses[b])throw new Error('No class aliased to "'+b+'".');return this._aliasedKlasses[b]},mapInjectables:function(a){angular.extend(this.injectablesMap,a)},_aliasedKlasses:{}}}}]),angular.module("Iguana").factory("Iguana.Callbacks",[function(){return{included:function(a){a.defineCallbacks("copyAttrs"),a.defineCallbacks("copyAttrsOnInitialize"),a.defineCallbacks("save")}}}]),angular.module("Iguana").factory("Iguana.Crud",["$injector",function(a){return{included:function(a){a.setIdProperty("id")},classMixin:{setCollection:function(a){this.extend({collection:a})},setAdapter:function(b){try{var c=a.get(b)}catch(d){throw new Error('Cannot find adapter "'+b+'"')}this.extend({adapterKlass:c})},setBaseUrl:function(a){a=a.replace(/\/$/,""),this.extend({baseUrl:a})},setIdProperty:function(a){this.extend({idProperty:a})},adapter:function(){if(!this._adapter){if(!this.adapterKlass)throw new Error("No adapter set.  You need to call setAdapter()");this._adapter=new this.adapterKlass(this)}return this._adapter},show:function(){return this._callAdapterMethAndInstantiateResult("show",!0,arguments)},index:function(){return this._callAdapterMethAndInstantiateResult("index",!1,arguments)},create:function(a){var b=this.new(a);if(!b.isNew())throw new Error("Cannot call create on instance that is already saved.");return b.save()},update:function(a){var b=this.new(a);if(b.isNew())throw new Error("Cannot call update on instance that is not already saved.");return b.save()},destroy:function(a){return this._callAdapterMeth("destroy",[a]).then(function(a){return this._prepareEmptyResponse(a)}.bind(this))},saveWithoutInstantiating:function(a,b){return this._callAdapterMeth(a,[b]).then(function(a){return{result:a.result[0],meta:a.meta}})},_prepareEmptyResponse:function(a){return{result:null,meta:a.meta}},_callAdapterMethAndInstantiateResult:function(a,b,c){return this._callAdapterMeth(a,c).then(function(a){return this._instantiateFromResponse(b,a)}.bind(this))},_instantiateFromResponse:function(a,b){var c=this._instantiateFromResult(b.result),d=a?c[0]:c;return{result:d,meta:b.meta}},_instantiateFromResult:function(a){if(!a)return[];var b=[];return angular.forEach(a,function(a){b.push(this.new(a))}.bind(this)),b},_callAdapterMeth:function(a,b){if(!this.collection)throw new Error("Cannot make an api call because collection has not been set.  You need to call setCollection().");return b=Array.prototype.slice.call(b,0),b.unshift(this.collection),this.adapter()[a].apply(this.adapter(),b)}},instanceMixin:{save:function(){var a;return this.runCallbacks("save",function(){a=this._save()}),a},isNew:function(){var a=this[this.idProperty()];return!a},_save:function(){var a=this.isNew()?"create":"update";return this.constructor.saveWithoutInstantiating(a,this.asJson()).then(function(a){var b=angular.extend({},a.result);return this.copyAttrs(b),{result:this,meta:a.meta}}.bind(this))},destroy:function(){return this.constructor.destroy(this[this.idProperty()])},idProperty:function(){return this.constructor.idProperty}}}}]),angular.module("Iguana").factory("Iguana.Embeds",["AClassAbove",function(a){var b=a.subclass({initialize:function(a,b){this.propName=a,this.klassFetcher=b},process:function(a,b){var c=b[this.propName];c&&(b[this.propName]=this._instantiate(a,c))}}),c=b.subclass({_instantiate:function(a,b){var c;if("[object Array]"===Object.prototype.toString.call(b))c=[];else{if("object"!=typeof b)throw new Error('Expecting array or object for embedsMany relationship "'+this.propName+'". Got '+b);c={}}return angular.forEach(b,function(b,d){var e=this.klassFetcher().new(b);e.$embeddedIn=a,c[d]=e}.bind(this)),c}}),d=b.subclass({_instantiate:function(a,b){var c=this.klassFetcher().new(b);return c.$embeddedIn=a,c}});return{included:function(a){a.extendableObject("embedRelationships"),a.setCallback("before","copyAttrs","processEmbeds")},classMixin:{embedsMany:function(a,b){this.embedRelationships().set(a,new c(a,this.getAliasedKlass.bind(this,b)))},embedsOne:function(a,b){this.embedRelationships().set(a,new d(a,this.getAliasedKlass.bind(this,b)))},embeddedIn:function(a){this.extend({_embeddedIn:a});var b={};b[a]=function(){return this.$embeddedIn},this.include(b)}},instanceMixin:{embedRelationships:function(){return this.constructor.embedRelationships.apply(this.constructor)},processEmbeds:function(){angular.forEach(this.embedRelationships(),function(a){a.process(this,this.$$sourceAttrs)}.bind(this))}}}}]),angular.module("Iguana").factory("Iguana.Serializers",[function(){return{instanceMixin:{asJson:function(){return angular.fromJson(angular.toJson(this))},toJson:function(){return angular.toJson(this)}}}}]),angular.module("Iguana").factory("Iguana.SingleCollectionInheritance",function(){return{included:function(a){a.setCallback("after","copyAttrs",function(){var a=this.constructor.sciProperty;this.constructor.alias()&&!this.hasOwnProperty(a)&&(this[a]=this.constructor.alias())}),a.setCallback("before","copyAttrsOnInitialize",function(){var a=this.$$sourceAttrs;if(!a||!a.$instantiatedWithNew)throw new Error("Iguana classes must be instantiated with MyKlass.new() rather that new MyKlass()");delete a.$instantiatedWithNew})},classMixin:{sciProperty:"__iguana_type",setSciProperty:function(a){this.extend({sciProperty:a})},"new":function(a,b){if(a=angular.extend({},a),b!==!1&&(b=!0),void 0===a&&(a={}),"object"!=typeof a||"[object Array]"===Object.prototype.toString.call(a))throw new Error("Expecting to instantiate Iguana class with object, got '"+a+"'");a.$instantiatedWithNew=!0;var c;if(!a.hasOwnProperty(this.sciProperty))return new this(a);if(a[this.sciProperty]&&a[this.sciProperty]===this.alias())c=new this(a);else{var d;try{d=this.getAliasedKlass(a[this.sciProperty])}catch(e){}if(d&&!d.inheritsFrom(this))throw new Error('Cannot instantiate because class "'+d.alias()+'" does not inherit from "'+this.alias()+'."');d&&(c=d.new(a,!1))}if(c)return c;if(b)throw new Error("No class could be found for "+this.sciProperty+'="'+a[this.sciProperty]+'".')}}}});